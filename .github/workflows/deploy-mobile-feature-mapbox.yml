name: Deploy Mobile App - Feature Branch (Mapbox Integration)

on:
  push:
    branches: [feature/mapbox-integration]
    paths: ['mobile-app/**']
  pull_request:
    branches: [develop]
    paths: ['mobile-app/**']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Run tests
        working-directory: mobile-app
        run: npm test || echo "No tests found"

      - name: Run linting
        working-directory: mobile-app
        run: npm run lint || echo "No lint script found"

      - name: Type check
        working-directory: mobile-app
        run: npx tsc --noEmit || echo "No TypeScript config found"

  build-feature:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/feature/mapbox-integration'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Set Firebase project to development
        working-directory: mobile-app
        run: |
          npx firebase use development --token ${{ secrets.FIREBASE_TOKEN }}

      - name: Copy development environment with Mapbox
        working-directory: mobile-app
        run: |
          cp .env.development .env
          echo "EXPO_PUBLIC_MAPBOX_ACCESS_TOKEN=${{ secrets.MAPBOX_ACCESS_TOKEN_DEV }}" >> .env

      - name: Build feature app (mapbox-dev)
        working-directory: mobile-app
        run: eas build --profile mapbox-dev --platform all --non-interactive

      - name: Comment PR with build link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üó∫Ô∏è Mapbox feature build triggered! Check EAS dashboard for progress.\n\n**Feature**: Mapbox Integration\n**Build Profile**: Preview\n**Branch**: `feature/mapbox-integration`'
            })

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Run security audit
        working-directory: mobile-app
        run: npm audit --audit-level moderate || true

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."
          grep -r "pk\." mobile-app/ || true
          grep -r "sk_" mobile-app/ || true
          grep -r "MAPBOX" mobile-app/ || true

  monitoring-setup:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate monitoring configuration
        run: |
          echo "Validating Mapbox monitoring setup..."
          
          # Check for required monitoring files
          if [ ! -f "mobile-app/MAPBOX_MONITORING.md" ]; then
            echo "‚ùå MAPBOX_MONITORING.md not found"
            exit 1
          fi
          
          echo "‚úÖ Monitoring documentation exists"
          
          # Verify Sentry configuration exists
          if grep -q "SENTRY" mobile-app/.env.development; then
            echo "‚úÖ Sentry configuration found in development environment"
          else
            echo "‚ö†Ô∏è  Sentry configuration not found in development environment"
          fi
          
          # Check for analytics tracking
          if [ -f "mobile-app/package.json" ]; then
            if grep -q "firebase.*analytics\|@react-native-firebase/analytics" mobile-app/package.json; then
              echo "‚úÖ Analytics dependency found"
            else
              echo "‚ö†Ô∏è  Analytics dependency not found - install @react-native-firebase/analytics"
            fi
          fi
          
          echo "üéØ Monitoring validation complete"

      - name: Test monitoring alerts configuration
        run: |
          echo "Testing alert configuration syntax..."
          
          # Validate alert configurations exist in documentation
          if grep -q "alert.*threshold\|notification.*channels" mobile-app/MAPBOX_MONITORING.md; then
            echo "‚úÖ Alert configurations found in documentation"
          else
            echo "‚ùå Alert configurations missing from documentation"
            exit 1
          fi
          
          echo "üö® Alert configuration validation complete"